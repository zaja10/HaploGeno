---
title: "Advanced Analysis & Visualization with HaploGeno"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced Analysis & Visualization with HaploGeno}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(HaploGeno)
```

# Introduction

While the introductory vignette covers the basic workflow of simulating and fitting models, **HaploGeno** offers a suite of advanced visualization and post-analysis tools designed to help breeders and geneticists interpret their results.

This vignette demonstrates how to:

1.  **Visualize Population Structure** using the Haplotype Relationship Matrix (HRM).
2.  **Interpret Local Signals** using Manhattan plots and GEBV heatmaps.
3.  **Perform Haplotype Stacking**, a technique to identify and select individuals accumulating favorable haplotype blocks.

We will use the package's built-in demo dataset, which comes pre-processed with defined blocks and calculated Local Genomic Estimated Breeding Values (GEBVs).

# 1. Loading the Demo Data

For quick exploration and testing, `HaploGeno` provides a pre-loaded dataset containing 50 individuals and 500 markers. The data was generated with a simulated signal in the first 50 markers.

```{r load_demo}
# Load the pre-processed demo dataset
haplo <- load_demo_data()

# Print the object summary to verify data status
print(haplo)
```

You will notice that the **Status** summary indicates that Genotypes, Maps, Blocks, Haplotypes, and the Model are already loaded or trained.

# 2. Visualizing Population Structure (PCA)

Before diving into marker effects, it is crucial to understand the genetic structure of your population. `HaploGeno` can perform Principal Component Analysis (PCA) directly on the computed Haplotype Relationship Matrix (HRM).

```{r pca, fig.width=6, fig.height=6}
# Plot the first two principal components of the HRM
haplo$plot_pca()
```

This plot helps identify clusters or stratification within the population. If you have group labels (e.g., family or origin), you can pass them to the `groups` argument to color the points accordingly.

# 3. Visualizing Genomic Signals

## Manhattan Plot of Local GEBVs

To identify genomic regions significantly associated with the phenotype, we use a Manhattan plot based on the variance of Local GEBVs. Since our demo data has simulated effects in the first 50 markers, we expect to see significant signals at the beginning of the chromosome.

```{r manhattan, fig.width=7, fig.height=5}
# Plot significance of local GEBV variances
# The threshold defaults to p < 0.05
haplo$plot_manhattan(threshold = 0.05)
```

The alternating colors (black/grey) indicate different chromosomes (or blocks mapping to them), and the red dashed line indicates the significance threshold.

## Local GEBV Heatmap

For a more granular view, the GEBV heatmap visualizes the estimated genetic value of every block for every individual. This allows you to see if specific individuals carry high-value haplotypes in specific regions.

```{r heatmap, fig.width=7, fig.height=6}
# Visualize the Local GEBV matrix
# X-axis: Block Index
# Y-axis: Individual Index
# Color: Blue (Low Value) to Red (High Value)
haplo$plot_gebv_image()
```

# 4. Haplotype Stacking Analysis

"Haplotype Stacking" is a powerful breeding strategy where the goal is to combine ("stack") superior haplotype blocks from different parents into a single individual. `HaploGeno` automates the identification of these superior blocks.

## Identifying Superior Haplotypes

First, we identify the specific haplotype alleles within significant blocks that have the highest positive effect on the phenotype.

```{r superior}
# Identify the best haplotype for the top 10 most significant blocks
superior_haplos <- haplo$identify_superior_haplotypes(top_n = 10)

# View the results
print(head(superior_haplos))
```

The output table lists the `BlockID`, the `BestHaploID` (the specific allele code), and its `EffectSize`.

## Scoring Individuals

Next, we score each individual based on how many of these superior haplotypes they possess. This "Stacking Score" is a simple count of favorable alleles.

```{r scoring}
# Calculate stacking scores for all individuals
scores <- haplo$score_stacking(superior_haplos)

# View scores for the first few individuals
head(scores)
```

## Validating the Trend

Finally, we visualize the relationship between the Stacking Score and the actual Phenotype. A strong positive correlation indicates that accumulating these specific haplotypes effectively drives phenotypic improvement.

```{r trend, fig.width=6, fig.height=6}
# Plot the stacking trend with a regression line and R-squared value
haplo$plot_stacking_trend(scores = scores)
```

# 5. Haplotype of Interest (HOI) Analysis

Beyond identifying blocks, we often want to deeply analyze a specific high-variance locus to identify which haplotypes are driving the superior performance.

## 5.1 Analyzing Effect Distributions

The `analyze_hoi()` function scales the local GEBVs for a specific block and analyzes their distribution. It assumes a multimodal distribution where one peak corresponds to the Haplotype of Interest (HOI).

```{r}
# Analyze a specific block (e.g., Block 1 which we know has signal)
# This function scales effects, detects peaks, and runs a t-test
hoi_res <- haplo$analyze_hoi(local_gebv = haplo$local_gebv, block_id = 1)

# Inspect the results
print(paste("P-value for separation:", format(hoi_res$p_value, digits = 4)))
print("Superior Haplotypes:")
print(hoi_res$hoi_haplotypes)
```

## 5.2 Visualizing the Split

We can visualize the distribution of effects and the split between the "high" and "low" groups.

```{r}
# Visualize distribution with simplified method
# We can also highlight specific "check" genotypes (e.g., individuals 1, 10, 30)
haplo$plot_hoi_distribution(block_id = 1, highlight_ind = c(1, 10, 30))
```

Individuals to the right of the green line carry the superior haplotypes (HOIs) for this locus.

# 6. Genomic Architecture Biplot

Finally, we can visualize the relationship between the overall population structure and the specific genomic regions driving differentiation. The **Genomic Architecture Biplot** plots individuals based on the PCA of the Haplotype Relationship Matrix (HRM) and overlays vectors representing the local GEBVs of high-variance haploblocks.

```{r}
# Plot the biplot showing the top 5 blocks
# This shows which blocks are driving the separation along the principal components
haplo$plot_haplo_biplot(top_n = 5, label_blocks = TRUE, highlight_ind = c(1, 10, 30))
```

-   **Points**: Individuals.
-   **Vectors**: High-variance haploblocks.
-   **Interpretation**: Length of the vector indicates how strongly that block differentiates the population. Direction indicates which individuals have high effects for that block.
